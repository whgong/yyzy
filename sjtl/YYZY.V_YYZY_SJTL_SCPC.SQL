SET SCHEMA ETLUSR; 
SET CURRENT PATH = SYSIBM,SYSFUN,SYSPROC,SYSIBMADM,ETLUSR; 

CREATE VIEW YYZY.V_YYZY_SJTL_SCPC
  AS 
WITH TMP_1 AS (
  select CAST(NULL AS BIGINT) AS SJTLZBDM,A.PDATE as TLSJ,B.PFPHDM,A.BATCH AS PHSCPC
    from MES.N_THROWMAT_BATCH A
      LEFT JOIN YS.T_YS_YYZY_PFPH_BATCHID B
      ON A.CGCD=B.PFPHBS
    where DATE(A.PDATE) between KSRQ and JSRQ
      AND A.PLCD='104'
      AND B.SCCJDM=2
  UNION ALL
  select CAST(NULL AS BIGINT) AS SJTLZBDM,A.PDATE AS TLSJ,B.PFPHDM,A.BATCH AS 
      PHSCPC
    from MES.N_THROWMAT_BATCH A
      LEFT JOIN YS.T_YS_YYZY_PFPH_BATCHID B
      ON A.CGCD=B.PFPHBS
    where DATE(A.PDATE) between KSRQ and JSRQ
      AND A.PLCD='107'
      AND B.SCCJDM=1
  union all
  select CAST(NULL AS BIGINT) AS SJTLZBDM,A.PDATE AS TLSJ,B.PFPHDM,
    A.BATCH AS PHSCPC
  from MES.N_THROWMAT_BATCH A
    LEFT JOIN YS.T_YS_YYZY_PFPH_BATCHID B
      ON A.CGCD=B.PFPHBS
  where DATE(A.PDATE) between KSRQ and JSRQ
    AND A.PLCD='106'
    AND B.SCCJDM=1
) 
,TMP_2 AS (
  select PLANDATE ,CGCD, CAST(COUNT(BATCHID) AS DECIMAL(18,6)) AS BATCHID 
    from SCZH.N_SCZH_TYL003_FLD 
    GROUP BY PLANDATE,CGCD 
) 
,TMP_3 AS (
  SELECT CAST(NULL AS BIGINT) AS SJTLZBDM,A.PLANDATE AS TLSJ,B.PFPHDM, 
      A.BATCHID AS PHSCPC
    FROM TMP_2 A
      LEFT JOIN YS.T_YS_YYZY_PFPH_BATCHID B
      ON A.CGCD=B.PFPHBS
    where DATE(A.PLANDATE) between KSRQ and JSRQ
      AND B.SCCJDM=1
) 
, TMP_JG AS (
  SELECT SJTLZBDM,TLSJ,PFPHDM,PHSCPC
    FROM TMP_1
  UNION ALL
  SELECT SJTLZBDM,TLSJ,PFPHDM,PHSCPC
    FROM TMP_3
) 
SELECT SJTLZBDM,TLSJ,PFPHDM,PHSCPC
  FROM TMP_JG
;

GRANT CONTROL ON TABLE YYZY.V_YYZY_SJTL_SCPC TO USER DB2INST2;
GRANT SELECT ON TABLE YYZY.V_YYZY_SJTL_SCPC TO USER KSUSR;